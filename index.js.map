{"version":3,"file":"index.js","sources":["src/index.js"],"sourcesContent":["import karas from 'karas';\nimport { version } from '../package.json';\n\nkaras.inject.requestAnimationFrame = function(cb) {\n  setTimeout(cb, 1000 / 60);\n};\n\nconst REFRESH = karas.Event.REFRESH_ASYNC = 'refresh-async';\n\nclass Root extends karas.Root {\n  // 需要小程序内部监听事件手动调用\n  onEvent(e) {\n    this.__wrapEvent(e, data => {\n      this.__emitEvent(data);\n    });\n  }\n  __wrapEvent(e, cb) {\n    const { id } = this.ctx;\n    my.createSelectorQuery().select(`#${id}`).boundingClientRect().exec(ret => {\n      let x, y;\n\n      if (ret && ret[0] && e.detail) {\n        const { clientX, clientY, x: ox, y: oy } = e.detail;\n        const { left, top, width, height } = ret[0];\n        const { __scx, __scy } = this;\n\n        x = ox ?? clientX - left;\n        y = oy ?? clientY - top;\n\n        if (!karas.util.isNil(__scx)) {\n          x /= __scx;\n        } else {\n          x *= this.width / width;\n        }\n        if (!karas.util.isNil(__scy)) {\n          y /= __scy;\n        } else {\n          y *= this.height / height;\n        }\n      }\n      cb({\n        event: e,\n        stopPropagation() {\n          this.__stopPropagation = true;\n        },\n        stopImmediatePropagation() {\n          this.__stopPropagation = true;\n          this.__stopImmediatePropagation = true;\n        },\n        preventDefault() {},\n        x,\n        y,\n        __hasEmitted: false,\n      });\n    });\n  }\n  appendTo(ctx) {\n    this.__children = karas.builder.initRoot(this.__cd, this);\n    this.__initProps();\n    this.__root = this;\n    this.__refreshLevel = karas.animate.level.REFLOW;\n    this.__ctx = ctx;\n    this.__renderMode = karas.mode.CANVAS;\n    this.__defs = {\n      clear() {},\n    };\n    this.refresh();\n  }\n\n  refresh(cb) {\n    let self = this;\n    let ctx = self.ctx;\n\n    function wrap() {\n      ctx.draw(true, function() {\n        self.emit(REFRESH);\n        cb && cb();\n      });\n    }\n\n    super.refresh(wrap);\n  }\n}\n\n// Root引用指过来\nlet createVd = karas.createVd;\nkaras.createVd = function(tagName, props, children) {\n  if(['canvas', 'svg'].indexOf(tagName) > -1) {\n    return new Root(tagName, props, children);\n  }\n  return createVd(tagName, props, children);\n};\n\nconst IMG = karas.inject.IMG;\nconst INIT = karas.inject.INIT;\nconst LOADING = karas.inject.LOADING;\nconst LOADED = karas.inject.LOADED;\n\nkaras.inject.measureImg = function(url, cb, optinos = {}) {\n  if(url.indexOf('data:') === 0) {\n    let { width = {}, height = {} } = optinos;\n    cb({\n      success: true,\n      width: width.value,\n      height: height.value,\n      url,\n      source: url,\n    });\n    return;\n  }\n  let cache = IMG[url] = IMG[url] || {\n    state: INIT,\n    task: [],\n  };\n  if(cache.state === LOADED) {\n    cb(cache);\n  }\n  else if(cache.state === LOADING) {\n    cache.task.push(cb);\n  }\n  else {\n    cache.state = LOADING;\n    cache.task.push(cb);\n    my.getImageInfo({\n      src: url,\n      success: function(res) {\n        cache.state = LOADED;\n        cache.success = true;\n        cache.width = res.width;\n        cache.height = res.height;\n        cache.source = url;\n        cache.url = url;\n        let list = cache.task.splice(0);\n        list.forEach(cb => cb(cache));\n      },\n      fail: function() {\n        cache.state = LOADED;\n        cache.success = false;\n        cache.url = url;\n        let list = cache.task.splice(0);\n        list.forEach(cb => cb(cache));\n      },\n    });\n  }\n};\n\nkaras.inject.isDom = function(o) {\n  return o && karas.util.isFunction(o.arc);\n}\n\nconst CANVAS = {};\n\nkaras.inject.setCacheCanvas = function(k, v) {\n  CANVAS[k] = v;\n};\n\nkaras.inject.getCacheCanvas = function(w, h, key = '__$$cache$$__') {\n  if(!CANVAS[key]) {\n    throw new Error('Need a cache canvas');\n  }\n  let o = CANVAS[key];\n  return {\n    ctx: o,\n    canvas: o,\n    draw(ctx) {\n      ctx.draw(true);\n    },\n  };\n};\n\nkaras.myVersion = version;\n\nexport default karas;\n"],"names":["karas","inject","requestAnimationFrame","cb","setTimeout","REFRESH","Event","REFRESH_ASYNC","Root","e","__wrapEvent","data","__emitEvent","id","ctx","my","createSelectorQuery","select","boundingClientRect","exec","ret","x","y","detail","clientX","clientY","ox","oy","left","top","width","height","__scx","__scy","util","isNil","event","stopPropagation","__stopPropagation","stopImmediatePropagation","__stopImmediatePropagation","preventDefault","__hasEmitted","__children","builder","initRoot","__cd","__initProps","__root","__refreshLevel","animate","level","REFLOW","__ctx","__renderMode","mode","CANVAS","__defs","clear","refresh","self","wrap","draw","emit","createVd","tagName","props","children","indexOf","IMG","INIT","LOADING","LOADED","measureImg","url","optinos","success","value","source","cache","state","task","push","getImageInfo","src","res","list","splice","forEach","fail","isDom","o","isFunction","arc","setCacheCanvas","k","v","getCacheCanvas","w","h","key","Error","canvas","myVersion","version"],"mappings":"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"}